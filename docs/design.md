# Дизайн Telegram-казино бота

## Обзор
Игровой бот — это Telegram-казино с внутриигровой валютой «чипами». Чипы не имеют реальной стоимости, но игрок может пополнить баланс через крипто-платёжного бота (интеграция описана интерфейсно). Бот поддерживает расширенный набор игр, ведёт журнал транзакций и персональную аналитику, прокачивает игрока через уровни, миссии и достижения. Вся логика построена вокруг принципов честности, прозрачности и ответственного гейминга.

## Цели продукта
- Предоставить игроку быстрый способ начать игру с помощью команды `/start`.
- Хранить баланс, историю ставок и транзакций.
- Позволить совершать внутриигровые операции: ежедневный бонус, депозит через CryptoBot (фиктивный), вывод на внешние кошельки (тоже фиктивный).
- Предложить несколько игр разной сложности: слоты, блэкджек, рулетка, краш, дуэль костей.
- Вести пользовательский прогресс: уровни, клубы лояльности, XP за ставки.
- Поддерживать миссии и достижения для удержания аудитории.
- Обеспечить честность результатов: использовать криптографически стойкий ГПСЧ Python (`secrets`), фиксировать сиды.
- Обеспечить масштабируемость: модульная архитектура, возможность добавления новых игр и сервисов.

## Пользовательские сценарии
1. **Вход и регистрация**
   - Пользователь отправляет `/start`.
   - Бот регистрирует профиль, инициализирует кошелёк (баланс = 0) и выдаёт приветственный бонус.

2. **Получение информации**
   - Команда `/profile` или кнопка «Профиль»: текущий баланс, история последних игр.
   - Команда `/help`: правила, описание валюты, предупреждения о вымышленных ставках, ссылки на миссии и достижения.

3. **Управление валютой**
   - **Ежедневный бонус** `/daily`: раз в 24 часа начисляет фиксированное количество чипов.
   - **Пополнение** `/deposit`: бот генерирует платёжную ссылку CryptoBot (интерфейсный модуль `crypto.py` возвращает заглушку, но интерфейс готов к интеграции).
   - **Вывод** `/withdraw`: игрок указывает сумму и адрес кошелька; операция логируется, но требует ручной модерации.

4. **Игровой процесс**
   - Игрок выбирает игру через инлайн-клавиатуру.
   - Указывает ставку и дополнительные параметры (например, выбор карты для блэкджека).
   - Получает мгновенный результат, бот обновляет баланс и сохраняет запись в истории.

5. **Социальные элементы**
   - `/leaderboard`: топ игроков по выигрышам за последние 7 дней.
   - `/stats`: персональная статистика: число игр, винрейт по каждой игре.

6. **Прогрессия и удержание**
   - `/missions` или кнопка «Миссии»: список ежедневных и недельных заданий, кнопки получения награды.
   - `/achievements`: перечень открытых достижений.
   - Сообщения после раунда уведомляют о новых достижениях, уровне и статусе клуба лояльности.

## Архитектура
```
casino_bot/
├── config.py          # статический конфиг с токенами и параметрами экономики
├── main.py            # точка входа, инициализация бота
├── keyboards.py       # клавиатуры и кнопки
├── storage.py         # абстракция над SQLite
├── crypto.py          # интеграция с CryptoBot (заглушка)
├── handlers/
│   ├── common.py      # команды /start, /help, профиль
│   ├── economy.py     # бонусы, депозит, вывод
│   ├── games.py       # игровой процесс
│   └── progression.py # миссии, достижения, лояльность
├── services/
│   ├── economy.py     # бизнес-логика кошелька
│   ├── progression.py # XP, миссии, достижения
│   └── games/
│       ├── base.py
│       ├── slots.py
│       ├── blackjack.py
│       ├── coinflip.py
│       ├── roulette.py
│       ├── dice.py
│       └── crash.py
└── utils/
    └── scheduler.py   # планирование повторяющихся задач (например, очистка кеша)
```

### Основные компоненты
- **`config.py`**: хранит словарь `CONFIG` с токенами, параметрами бонусов и лимитов ставок. `load_settings()` возвращает dataclass `Settings` с нужными полями.
- **`storage.py`**: управление SQLite; таблицы `users`, `transactions`, `game_rounds`, `daily_bonus`, `user_stats`, `user_game_stats`, `missions`, `achievements`. Обеспечивает ACID через транзакции.
- **`services/economy.py`**: манипулирует балансами, бонусами, транзакциями.
- **`services/progression.py`**: отвечает за XP, уровни, клубы, миссии и достижения.
- **`services/games/*`**: отдельный модуль на игру. Общий интерфейс `GameStrategy` с методом `play()`.
- **`handlers/`**: слой Telegram. Каждый модуль регистрирует роутеры для `aiogram`.
- **`utils/scheduler.py`**: обёртка вокруг `asyncio.create_task` и `asyncio.sleep` для запуска периодических задач.

## Модели данных
- `User`: `telegram_id`, `username`, `balance`, `created_at`.
- `Transaction`: `id`, `user_id`, `type`, `amount`, `meta`, `created_at`.
- `GameRound`: `id`, `user_id`, `game`, `bet`, `payout`, `state_json`, `created_at`.
- `DailyBonus`: `user_id`, `last_claimed_at`.
- `UserStats`: `user_id`, `xp`, `total_wagered`, `total_won`, `games_played`, `wins`, `losses`, `biggest_win`.
- `UserGameStats`: `user_id`, `game`, `games_played`, `total_wagered`, `total_won`.
- `Achievements`: `id`, `code`, `title`, `description`, `threshold`, `metric`.
- `UserAchievements`: `user_id`, `achievement_id`, `unlocked_at`.
- `Missions`: `id`, `code`, `title`, `description`, `target`, `reward`, `metric`, `frequency` (`daily`, `weekly`).
- `UserMissions`: `user_id`, `mission_id`, `progress`, `completed_at`, `claimed_at`.

## Игры и правила
### 1. Слот-машина
- Сетка 3x3, символы: вишня, бар, семёрка, лимон, колокольчик.
- Генератор `secrets.choice`.
- Выигрышные комбинации: три одинаковых по горизонтали, либо любые «семёрки».
- РТП ~92%. Множители: 7x за семёрки, 5x за бары, 3x за вишни, 2x за лимоны.

### 2. Блэкджек (1 на 1 с дилером)
- Колода 52 карт, тасуется каждый раунд.
- Игрок может «Hit», «Stand», «Double».
- Дилер добирает до 17.
- Ставка удваивается при Double, блэкджек (21) платит 3:2.

### 3. Монетка
- Игрок выбирает «Орел» или «Решка».
- Честное распределение 50/50 через `secrets.choice`.
- Выигрыш 1.9x (домашняя комиссия 5%).

### 4. Рулетка
- Европейское колесо на 37 чисел (0–36), цвета распределены классически.
- Ставки на красное/чёрное платят 2x, ставка на зеро — 14x.
- Реализация `Roulette` использует `secrets.randbelow` и таблицу цветов.

### 5. Дуэль костей
- Игрок и дилер бросают кость (`randbelow(6) + 1`).
- Победа — 2x, ничья — возврат, поражение — 0.
- Простая и быстрая игра для минимальных ставок.

### 6. Crash
- Случайный множитель до x10 определяется генератором `SystemRandom`.
- Бот автоматически выставляет осторожный авто-выход (x1.3–x3.5).
- Если график не «крашится» раньше авто-выхода, ставка умножается на множитель.

## Экономические правила
- Минимальная ставка: 10 чипов.
- Максимальная ставка: 10% от общего банка или 10 000.
- Ежедневный бонус: 250 чипов.
- Начальный бонус при `/start`: 500 чипов.
- Пополнение через CryptoBot: от 5 до 100 USD, курс берётся из `crypto.py` (заглушка возвращает фиксированный).
- Награды за миссии: 200 чипов (дневные) и 600 чипов (недельные).
- Уровни лояльности: Bronze → Silver (5k оборота) → Gold (25k) → Platinum (75k) → Diamond (150k) с бонус-множителями на акции.

## Прогрессия и удержание
- **XP и уровни**: XP начисляется за каждую ставку (1 XP за 10 чипов + бонус за крупные выигрыши). Порог следующего уровня увеличивается на 150 XP каждый уровень.
- **Клубы лояльности**: текущий клуб определяется суммарным оборотом ставок. Чем выше клуб, тем больше множитель для специальных акций и турниров.
- **Миссии**: ежедневные (сыграть 5 раундов, поставить 2 000 чипов) и недельные (выиграть 7 500 чипов). После выполнения требуется вручную забрать награду через `/missions` или кнопку.
- **Достижения**: «Первый выигрыш», «Постоянный игрок», «Хайроллер», «Крупный куш». Каждое достижение фиксируется в профиле и выдаёт эмблему.
- **Уведомления**: после каждого раунда бот сообщает об открытых достижениях, прогрессе миссий и текущем уровне, мотивируя продолжать игру.

## Дизайн взаимодействия (UX)
- Главное меню в инлайн-клавиатуре: «Играть», «Профиль», «Бонус», «Пополнить», «Миссии», «Лидерборд» (две колонки).
- После выбора игры отображается клавиатура ставок (быстрый выбор) + возможность ввести произвольную.
- Игры с выбором опции (монетка, рулетка, блэкджек) имеют дополнительные клавиатуры действий.
- Бот отправляет эмодзи, визуализирующие игры (например, барабаны слота или колесо рулетки).
- Результаты раунда дополняются блоком о прогрессе: уровень, клуб, новые достижения, миссии для получения награды.

## Расширение и поддержка
- Добавление новых игр: достаточно реализовать новый класс, зарегистрировать его в `GameRegistry`.
- Интеграция с реальным CryptoBot: заменить заглушки в `crypto.py`, обеспечить вебхуки.
- Ведение статистики и аналитики: модуль `storage` сохраняет подробные данные по игроку и каждой игре, доступно строить отчётность.
- Расширение миссий/достижений: достаточно добавить записи в таблицы `missions`/`achievements`, бот автоматически подхватит их при запуске.
- Внешние сервисы (турниры, магазин) могут использовать агрегированные таблицы статистики без дополнительной нагрузки на игровой процесс.

## Безопасность и честность
- Все случайные события основаны на `secrets.SystemRandom`.
- В журнале игры хранится исходный сид и роллы, доступные по запросу пользователя.
- Проверки минимального баланса и ставок выполняются в сервисном слое, исключая мошенничество через пользовательские команды.

## Тестирование
- Юнит-тесты игровых стратегий (слоты, монетка, блэкджек) можно написать на базе `pytest`.
- Интеграционные тесты бота: использовать `aiogram` тестовый клиент.
- Набор `make` целей для запуска линтеров и тестов.

